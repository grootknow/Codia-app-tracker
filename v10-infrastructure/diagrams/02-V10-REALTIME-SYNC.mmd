%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#E3F2FD','primaryTextColor':'#1565C0','primaryBorderColor':'#1976D2','lineColor':'#424242','fontSize':'14px'}}}%%

graph TB
    %% ============================================================================
    %% V10 ULTIMATE REALTIME SYNC - Supabase Realtime + WebSocket + CDC + Event Bus
    %% ============================================================================
    
    subgraph USER_LAYER["ğŸ‘¥ USER LAYER"]
        FOUNDER["ğŸ‘¤ Founder<br/>LobeChat Client"]
        NOTION_USER["ğŸ“ Notion<br/>Web/Mobile App"]
    end
    
    subgraph VPS3_REALTIME["ğŸ¤– VPS3: REALTIME COMPONENTS"]
        WEBSOCKET["ğŸ”Œ WEBSOCKET SERVER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Port: 8888<br/>Tech: Socket.IO<br/>Connections: 100+<br/>Latency: <50ms"]
        
        LANGGRAPH_RT["ğŸ”„ LANGGRAPH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Event Consumer<br/>Subscribe to all channels<br/>Process in <100ms"]
    end
    
    subgraph VPS2_EVENTBUS["ğŸ—„ï¸ VPS2: EVENT BUS & CDC"]
        direction TB
        
        subgraph REDIS_PUBSUB["ğŸ“¡ REDIS PUB/SUB"]
            EVENTS_NOTION["ğŸ“ /events/notion/*<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Task updates<br/>Database changes<br/>User actions"]
            
            EVENTS_DB["ğŸ—„ï¸ /events/db/*<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PostgreSQL changes<br/>Neo4j changes<br/>Qdrant updates"]
            
            EVENTS_AI["ğŸ¤– /events/ai/*<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Task completed<br/>AI responses<br/>Workflow results"]
        end
        
        CDC["ğŸ”„ CDC (Change Data Capture)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PostgreSQL: Logical Replication<br/>Neo4j: CDC Plugin<br/>Latency: <100ms"]
        
        POSTGRES_CDC["ğŸ—„ï¸ PostgreSQL<br/>Logical Replication Slot"]
        NEO4J_CDC["ğŸ“Š Neo4j<br/>CDC Plugin"]
    end
    
    subgraph VPS1_WEBHOOKS["ğŸ–¥ï¸ VPS1: WEBHOOK RECEIVER & REALTIME"]
        WINDMILL_WEBHOOK["ğŸŒªï¸ Windmill Webhook<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Port: 8000/webhook<br/>Receives: Notion webhooks<br/>Process: <50ms"]
        
        SUPABASE_RT["âš¡ SUPABASE REALTIME<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Port: 4000<br/>WebSocket Sync<br/>Broadcast + Presence<br/>Latency: <100ms"]
    end
    
    %% ============================================================================
    %% DATA FLOWS
    %% ============================================================================
    
    %% Flow 1: User â†’ AI (Chat)
    FOUNDER -->|WebSocket| WEBSOCKET
    WEBSOCKET -->|Push message| LANGGRAPH_RT
    LANGGRAPH_RT -->|Query DB| POSTGRES_CDC
    LANGGRAPH_RT -->|Publish result| EVENTS_AI
    EVENTS_AI -.->|WebSocket push| WEBSOCKET
    WEBSOCKET -.->|Response| FOUNDER
    
    %% Flow 2: Notion â†’ AI (Váº­n hÃ nh)
    NOTION_USER -->|Webhook <1s| WINDMILL_WEBHOOK
    WINDMILL_WEBHOOK -->|Publish| EVENTS_NOTION
    WINDMILL_WEBHOOK -.->|Broadcast| SUPABASE_RT
    SUPABASE_RT -.->|WebSocket| WEBSOCKET
    EVENTS_NOTION -->|Subscribe| LANGGRAPH_RT
    LANGGRAPH_RT -->|Process| EVENTS_AI
    
    %% Flow 3: Database â†’ AI (CDC)
    POSTGRES_CDC -.->|Change detected| CDC
    NEO4J_CDC -.->|Change detected| CDC
    CDC -->|Publish| EVENTS_DB
    EVENTS_DB -->|Subscribe| LANGGRAPH_RT
    
    %% Flow 4: AI â†’ User (Realtime update)
    LANGGRAPH_RT -->|Task complete| EVENTS_AI
    EVENTS_AI -.->|WebSocket broadcast| WEBSOCKET
    WEBSOCKET -.->|Push notification| FOUNDER
    
    %% ============================================================================
    %% LATENCY BREAKDOWN
    %% ============================================================================
    
    subgraph LATENCY["âš¡ LATENCY COMPARISON"]
        direction LR
        
        V7_LATENCY["âŒ V7 (CRUD)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Notion update<br/>â†“ 5-15 min (polling)<br/>â†“ PostgreSQL write<br/>â†“ AI sees change<br/>TOTAL: 5-15 minutes"]
        
        V10_LATENCY["âœ… V10 ULTIMATE (Realtime)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Notion update<br/>â†“ <1s (Windmill webhook)<br/>â†“ Supabase Realtime broadcast<br/>â†“ Redis Pub/Sub<br/>â†“ AI consumes event<br/>â†“ WebSocket push<br/>TOTAL: <100ms â­ 2x faster!"]
    end
    
    %% ============================================================================
    %% TECHNOLOGIES
    %% ============================================================================
    
    subgraph TECH_STACK["ğŸ› ï¸ TECHNOLOGY STACK"]
        direction LR
        
        TECH_WS["WebSocket<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Socket.IO<br/>Bidirectional<br/>100+ connections"]
        
        TECH_REDIS["Redis Pub/Sub<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Event Bus<br/>3 channels<br/>1000+ msg/min"]
        
        TECH_CDC_PG["PostgreSQL CDC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Logical Replication<br/>pg_notify<br/>No Kafka needed"]
        
        TECH_WEBHOOK["Webhooks<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Windmill receiver<br/>Notion â†’ Windmill<br/>HTTP POST"]
    end
    
    %% Styling
    classDef userStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    classDef realtimeStyle fill:#E1F5FE,stroke:#0277BD,stroke-width:3px
    classDef eventStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:3px
    classDef webhookStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px
    classDef latencyStyle fill:#FFEBEE,stroke:#C62828,stroke-width:2px
    classDef techStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    
    class FOUNDER,NOTION_USER userStyle
    class WEBSOCKET,LANGGRAPH_RT realtimeStyle
    class REDIS_PUBSUB,EVENTS_NOTION,EVENTS_DB,EVENTS_AI,CDC,POSTGRES_CDC,NEO4J_CDC eventStyle
    class WINDMILL_WEBHOOK webhookStyle
    class V7_LATENCY,V9_LATENCY latencyStyle
    class TECH_WS,TECH_REDIS,TECH_CDC_PG,TECH_WEBHOOK techStyle
