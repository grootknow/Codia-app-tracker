%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#E0F2F1','primaryTextColor':'#00897B','primaryBorderColor':'#00897B','lineColor':'#424242','fontSize':'14px'}}}%%

graph TB
    %% ============================================================================
    %% V9 DATA STORAGE & LAKEHOUSE ARCHITECTURE
    %% ============================================================================
    
    subgraph SOURCE_SYSTEMS["ğŸ“Š SOURCE SYSTEMS"]
        direction LR
        
        PG_SOURCE["ğŸ—„ï¸ POSTGRESQL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>4 Databases:<br/>â€¢ Core (Coolify, Logto)<br/>â€¢ App (MetaMCP, Postiz)<br/>â€¢ Zep (Memory)<br/>â€¢ NocoDB<br/><br/>Total: 6GB data<br/>WAL enabled"]
        
        NEO4J_SOURCE["ğŸ“Š NEO4J<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>2 Instances:<br/>â€¢ Internal (2M triples)<br/>â€¢ SuperApp (19M triples)<br/><br/>Total: 21M triples<br/>CDC plugin enabled"]
        
        LANCEDB_SOURCE["ğŸš€ LANCEDB<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Collections:<br/>â€¢ Embeddings (10M vectors)<br/>â€¢ Metadata<br/><br/>Total: 10M vectors (Embedded!)<br/>Arrow format<br/>500MB RAM only"]
        
        REDIS_SOURCE["âš¡ REDIS<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Data:<br/>â€¢ Cache (hot data)<br/>â€¢ Queue (tasks)<br/>â€¢ Pub/Sub (events)<br/><br/>Total: 1GB<br/>RDB snapshots"]
    end
    
    subgraph CDC_LAYER["ğŸ”„ CHANGE DATA CAPTURE (CDC)"]
        direction TB
        
        PG_CDC["ğŸ“ POSTGRESQL CDC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Method: Logical Replication<br/>Tool: pg_logical_replication<br/>Slot: trm_cdc_slot<br/>Publication: trm_pub<br/><br/>Captures:<br/>â€¢ INSERT, UPDATE, DELETE<br/>â€¢ Schema changes<br/>â€¢ Transaction metadata<br/><br/>Latency: <50ms<br/>Throughput: 500 events/min"]
        
        NEO4J_CDC["ğŸ“ NEO4J CDC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Method: CDC Plugin<br/>Tool: neo4j-cdc-plugin<br/>Stream: trm_neo4j_stream<br/><br/>Captures:<br/>â€¢ Node create/update/delete<br/>â€¢ Relationship changes<br/>â€¢ Property changes<br/><br/>Latency: <100ms<br/>Throughput: 300 events/min"]
        
        LANCEDB_CDC["ğŸ“ LANCEDB CDC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Method: File watcher<br/>Tool: Arrow IPC stream<br/><br/>Captures:<br/>â€¢ Vector upsert<br/>â€¢ Collection changes<br/>â€¢ Metadata updates<br/><br/>Latency: <100ms â­ Faster!<br/>Throughput: 500 events/min"]
    end
    
    subgraph EVENT_BUS["ğŸ“¡ EVENT BUS (Redis Streams)"]
        direction LR
        
        STREAM_PG["ğŸ“Š Stream: cdc_postgres<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Consumer Groups:<br/>â€¢ lakehouse_writer<br/>â€¢ ai_processor<br/>â€¢ analytics<br/><br/>Max Length: 10,000<br/>TTL: 24 hours"]
        
        STREAM_NEO4J["ğŸ“Š Stream: cdc_neo4j<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Consumer Groups:<br/>â€¢ lakehouse_writer<br/>â€¢ graph_analyzer<br/><br/>Max Length: 10,000<br/>TTL: 24 hours"]
        
        STREAM_LANCEDB["ğŸ“Š Stream: cdc_lancedb<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Consumer Groups:<br/>â€¢ lakehouse_writer<br/>â€¢ vector_analyzer<br/><br/>Max Length: 5,000<br/>TTL: 12 hours"]
    end
    
    subgraph LAKEHOUSE["ğŸ  LAKEHOUSE ARCHITECTURE (Cloudflare R2)"]
        direction TB
        
        subgraph BRONZE_LAYER["ğŸ¥‰ BRONZE LAYER (Raw)"]
            BRONZE["ğŸ“ /bronze/<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Raw CDC events (JSON)<br/><br/>Structure:<br/>â”œâ”€â”€ postgres/<br/>â”‚   â”œâ”€â”€ YYYY/MM/DD/<br/>â”‚   â””â”€â”€ events.json<br/>â”œâ”€â”€ neo4j/<br/>â”‚   â”œâ”€â”€ YYYY/MM/DD/<br/>â”‚   â””â”€â”€ events.json<br/>â””â”€â”€ qdrant/<br/>    â”œâ”€â”€ YYYY/MM/DD/<br/>    â””â”€â”€ events.json<br/><br/>Retention: 7 days<br/>Size: ~500MB/day"]
        end
        
        subgraph SILVER_LAYER["ğŸ¥ˆ SILVER LAYER (Cleaned)"]
            SILVER["ğŸ“ /silver/<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Cleaned & validated (Parquet)<br/><br/>Structure:<br/>â”œâ”€â”€ postgres/<br/>â”‚   â”œâ”€â”€ tables/<br/>â”‚   â””â”€â”€ YYYY/MM/DD/<br/>â”œâ”€â”€ neo4j/<br/>â”‚   â”œâ”€â”€ nodes/<br/>â”‚   â”œâ”€â”€ relationships/<br/>â”‚   â””â”€â”€ YYYY/MM/DD/<br/>â””â”€â”€ qdrant/<br/>    â”œâ”€â”€ vectors/<br/>    â””â”€â”€ YYYY/MM/DD/<br/><br/>Format: Parquet + Snappy<br/>Retention: 30 days<br/>Size: ~200MB/day (compressed)"]
        end
        
        subgraph GOLD_LAYER["ğŸ¥‡ GOLD LAYER (Aggregated)"]
            GOLD["ğŸ“ /gold/<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Business metrics (Parquet)<br/><br/>Structure:<br/>â”œâ”€â”€ daily/<br/>â”‚   â”œâ”€â”€ user_activity<br/>â”‚   â”œâ”€â”€ ai_usage<br/>â”‚   â””â”€â”€ system_health<br/>â”œâ”€â”€ weekly/<br/>â”‚   â””â”€â”€ summaries<br/>â””â”€â”€ monthly/<br/>    â””â”€â”€ reports<br/><br/>Format: Parquet + Snappy<br/>Retention: 90 days<br/>Size: ~50MB/day"]
        end
        
        ICEBERG["ğŸ“‹ ICEBERG CATALOG<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Metadata management<br/><br/>Features:<br/>â€¢ Schema evolution<br/>â€¢ Time travel<br/>â€¢ Partition pruning<br/>â€¢ ACID transactions<br/><br/>Storage: R2 /metadata/<br/>Size: ~10MB"]
    end
    
    subgraph QUERY_ENGINE["ğŸ” QUERY ENGINE (DuckDB)"]
        direction LR
        
        DUCKDB["ğŸ¦† DUCKDB<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Embedded analytics DB<br/><br/>Features:<br/>â€¢ Read Parquet directly from R2<br/>â€¢ SQL queries on lakehouse<br/>â€¢ Fast aggregations<br/>â€¢ Export to CSV/JSON<br/><br/>Use Cases:<br/>â€¢ Ad-hoc analytics<br/>â€¢ Report generation<br/>â€¢ Data exploration<br/><br/>Deployment: VPS3 (LangGraph)"]
        
        QUERY_API["ğŸŒ QUERY API<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>REST API for lakehouse queries<br/><br/>Endpoints:<br/>â€¢ POST /query (SQL)<br/>â€¢ GET /tables<br/>â€¢ GET /schema/{table}<br/>â€¢ GET /export/{format}<br/><br/>Auth: Logto JWT<br/>Rate Limit: 100 req/min"]
    end
    
    subgraph BACKUP_TIERS["ğŸ’¾ MULTI-TIER BACKUP STRATEGY"]
        direction TB
        
        TIER1["ğŸ”´ TIER 1: PRIMARY (R2)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Frequency: Every 4-6 hours<br/>Method: pg_dump, neo4j-admin, lancedb backup<br/>Storage: R2 /backups/<br/>Retention: 30 days<br/>Cost: $1.50/mo<br/><br/>Automation: Windmill workflow<br/>Verification: SHA-256 checksum<br/>Alert: Slack on failure"]
        
        TIER2["ğŸŸ¡ TIER 2: SECONDARY (Google Drive)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Frequency: Daily (critical only)<br/>Method: Encrypted zip<br/>Storage: GDrive /Backups/<br/>Retention: 30 days<br/>Cost: FREE<br/><br/>Includes:<br/>â€¢ Vaultwarden (GPG encrypted)<br/>â€¢ PostgreSQL Core<br/>â€¢ Neo4j Internal<br/>â€¢ Configs"]
        
        TIER3["ğŸŸ¢ TIER 3: COLD STORAGE (R2 Glacier)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Frequency: Weekly<br/>Method: Lifecycle policy<br/>Storage: R2 Glacier tier<br/>Retention: 1 year<br/>Cost: $0.50/mo<br/><br/>Includes:<br/>â€¢ Monthly full snapshots<br/>â€¢ Audit logs<br/>â€¢ Compliance records<br/>â€¢ Historical data"]
        
        TIER4["âšª TIER 4: VERSION CONTROL (GitHub)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Frequency: On change<br/>Method: Git auto-commit<br/>Storage: Private repos<br/>Retention: Unlimited<br/>Cost: FREE<br/><br/>Includes:<br/>â€¢ Windmill workflows (Python/TS)<br/>â€¢ Skills Library (Python)<br/>â€¢ Infrastructure as Code<br/>â€¢ Documentation (Markdown)"]
    end
    
    subgraph SYNC_STRATEGY["ğŸ”„ SYNC & CONSISTENCY"]
        direction LR
        
        SYNC_REALTIME["âš¡ REALTIME SYNC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>CDC â†’ Redis Streams â†’ Lakehouse<br/>Latency: <200ms<br/>Guarantee: At-least-once<br/><br/>Use Cases:<br/>â€¢ Live dashboards<br/>â€¢ AI real-time processing<br/>â€¢ Event-driven workflows"]
        
        SYNC_BATCH["ğŸ“¦ BATCH SYNC<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Scheduled jobs (Windmill)<br/>Frequency: Hourly/Daily<br/>Guarantee: Exactly-once<br/><br/>Use Cases:<br/>â€¢ Historical data migration<br/>â€¢ Large dataset processing<br/>â€¢ Report generation"]
        
        CONSISTENCY["âœ… CONSISTENCY MODEL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Bronze: Eventual consistency<br/>Silver: Strong consistency<br/>Gold: Strong consistency<br/><br/>Conflict Resolution:<br/>â€¢ Last-write-wins (timestamp)<br/>â€¢ Manual review (critical data)"]
    end
    
    %% ============================================================================
    %% DATA FLOWS
    %% ============================================================================
    
    %% Source â†’ CDC
    PG_SOURCE -->|WAL| PG_CDC
    NEO4J_SOURCE -->|Plugin| NEO4J_CDC
    LANCEDB_SOURCE -->|Arrow IPC| LANCEDB_CDC
    
    %% CDC â†’ Event Bus
    PG_CDC -->|Publish| STREAM_PG
    NEO4J_CDC -->|Publish| STREAM_NEO4J
    LANCEDB_CDC -->|Publish| STREAM_LANCEDB
    
    %% Event Bus â†’ Lakehouse
    STREAM_PG -->|Consume| BRONZE
    STREAM_NEO4J -->|Consume| BRONZE
    STREAM_LANCEDB -->|Consume| BRONZE
    
    %% Lakehouse layers
    BRONZE -->|Transform| SILVER
    SILVER -->|Aggregate| GOLD
    ICEBERG -.->|Manage| BRONZE
    ICEBERG -.->|Manage| SILVER
    ICEBERG -.->|Manage| GOLD
    
    %% Query engine
    DUCKDB -->|Read| SILVER
    DUCKDB -->|Read| GOLD
    QUERY_API -->|Execute| DUCKDB
    
    %% Backup flows
    PG_SOURCE -->|Dump| TIER1
    NEO4J_SOURCE -->|Dump| TIER1
    LANCEDB_SOURCE -->|Arrow export| TIER1
    REDIS_SOURCE -->|RDB| TIER1
    
    TIER1 -->|Critical| TIER2
    TIER1 -->|Weekly| TIER3
    GOLD -->|Archive| TIER3
    
    %% Sync
    STREAM_PG -.->|Realtime| SYNC_REALTIME
    BRONZE -.->|Batch| SYNC_BATCH
    
    %% Styling
    classDef sourceStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef cdcStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    classDef eventStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef lakehouseStyle fill:#E0F2F1,stroke:#00897B,stroke-width:3px
    classDef queryStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    classDef backupStyle fill:#FFEBEE,stroke:#C62828,stroke-width:2px
    classDef syncStyle fill:#E8EAF6,stroke:#3F51B5,stroke-width:2px
    
    class PG_SOURCE,NEO4J_SOURCE,LANCEDB_SOURCE,REDIS_SOURCE sourceStyle
    class PG_CDC,NEO4J_CDC,LANCEDB_CDC cdcStyle
    class STREAM_PG,STREAM_NEO4J,STREAM_LANCEDB eventStyle
    class BRONZE,SILVER,GOLD,ICEBERG lakehouseStyle
    class DUCKDB,QUERY_API queryStyle
    class TIER1,TIER2,TIER3,TIER4 backupStyle
    class SYNC_REALTIME,SYNC_BATCH,CONSISTENCY syncStyle
