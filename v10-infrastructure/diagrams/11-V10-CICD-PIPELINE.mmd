%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#E8F5E9',
    'primaryTextColor': '#388E3C',
    'primaryBorderColor': '#4CAF50',
    'lineColor': '#424242',
    'secondaryColor': '#E1F5FE',
    'tertiaryColor': '#FFF3E0',
    'fontSize': '14px'
  }
}}%%

graph TB
    %% ============================================================================
    %% V10 CI/CD PIPELINE - GITEA ACTIONS + TRIVY
    %% ============================================================================
    %% Version: 10.0 ULTIMATE
    %% Focus: Complete CI/CD with Security Scanning
    %% Date: 2025-11-04
    
    subgraph DEVELOPER["ğŸ‘¨â€ğŸ’» DEVELOPER"]
        DEV["ğŸ‘¨â€ğŸ’» DEVELOPER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions:<br/>â€¢ Write code<br/>â€¢ Commit changes<br/>â€¢ Push to main<br/>â€¢ Create PR<br/>â€¢ Review results"]
    end
    
    subgraph GITEA_SYSTEM["ğŸ”„ GITEA SYSTEM (VPS1 - 1GB)"]
        direction TB
        
        GITEA["ğŸ”„ GITEA<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Port 3001<br/><br/>Features:<br/>â€¢ Git repository<br/>â€¢ Gitea Actions<br/>â€¢ Webhooks<br/>â€¢ SSH access<br/>â€¢ Web UI"]
        
        GITEA_DB["ğŸ—„ï¸ GITEA DB<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PostgreSQL<br/>500MB<br/><br/>Stores:<br/>â€¢ Repos<br/>â€¢ Users<br/>â€¢ Issues<br/>â€¢ PRs"]
        
        RUNNER["ğŸƒ GITEA RUNNER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>500MB<br/><br/>Executes:<br/>â€¢ Workflows<br/>â€¢ Build jobs<br/>â€¢ Tests<br/>â€¢ Deployments"]
    end
    
    subgraph PIPELINE["ğŸ”„ CI/CD PIPELINE"]
        direction TB
        
        TRIGGER["1ï¸âƒ£ TRIGGER<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Events:<br/>â€¢ Push to main<br/>â€¢ Pull request<br/>â€¢ Tag created<br/>â€¢ Manual trigger<br/><br/>Duration: <1s"]
        
        SECURITY["2ï¸âƒ£ SECURITY SCAN<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Tool: Trivy<br/><br/>Scans:<br/>â€¢ Filesystem<br/>â€¢ Dependencies<br/>â€¢ Secrets<br/>â€¢ Misconfigs<br/><br/>Blocks on:<br/>â€¢ CRITICAL<br/>â€¢ HIGH<br/><br/>Duration: 30-60s"]
        
        BUILD["3ï¸âƒ£ BUILD<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Actions:<br/>â€¢ Checkout code<br/>â€¢ Install deps<br/>â€¢ Run tests<br/>â€¢ Build Docker<br/>â€¢ Tag image<br/><br/>Duration: 2-3 min"]
        
        PUSH["4ï¸âƒ£ PUSH TO REGISTRY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Registry: Zot<br/>Port: 5000<br/><br/>Actions:<br/>â€¢ Tag image<br/>â€¢ Push to Zot<br/>â€¢ Verify upload<br/>â€¢ Update manifest<br/><br/>Duration: 30s"]
        
        DEPLOY["5ï¸âƒ£ DEPLOY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Tool: Coolify<br/><br/>Actions:<br/>â€¢ Trigger webhook<br/>â€¢ Pull image<br/>â€¢ Stop old<br/>â€¢ Start new<br/>â€¢ Health check<br/><br/>Duration: 1-2 min"]
        
        VERIFY["6ï¸âƒ£ VERIFY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Checks:<br/>â€¢ Health endpoint<br/>â€¢ Smoke tests<br/>â€¢ Metrics check<br/>â€¢ Error rate<br/><br/>Duration: 30s"]
        
        NOTIFY["7ï¸âƒ£ NOTIFY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Channels:<br/>â€¢ Slack<br/>â€¢ Email<br/>â€¢ Grafana<br/>â€¢ DevOps Agent<br/><br/>Duration: <5s"]
    end
    
    subgraph SECURITY_TOOLS["ğŸ›¡ï¸ SECURITY TOOLS (VPS1)"]
        direction LR
        
        TRIVY["ğŸ›¡ï¸ TRIVY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>500MB | On-demand<br/><br/>Scans:<br/>â€¢ Filesystem<br/>â€¢ Container images<br/>â€¢ IaC configs<br/>â€¢ Secrets<br/><br/>Databases:<br/>â€¢ CVE database<br/>â€¢ Vulnerability DB<br/>â€¢ Updated daily<br/><br/>Output:<br/>â€¢ SARIF format<br/>â€¢ JSON report<br/>â€¢ Exit code"]
        
        TRIVYIGNORE["ğŸ“ .trivyignore<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>False positives<br/>Accepted risks<br/>Temporary ignores"]
    end
    
    subgraph REGISTRY["ğŸ“¦ DOCKER REGISTRY (VPS1)"]
        direction TB
        
        ZOT["ğŸ“¦ ZOT REGISTRY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>500MB | Port 5000<br/><br/>Features:<br/>â€¢ OCI-compliant<br/>â€¢ Image signing<br/>â€¢ Vulnerability scan<br/>â€¢ Garbage collection<br/><br/>Storage:<br/>â€¢ Local filesystem<br/>â€¢ Backed up to R2<br/>â€¢ Retention: 30 days"]
    end
    
    subgraph DEPLOYMENT["ğŸš€ DEPLOYMENT (VPS1)"]
        direction TB
        
        COOLIFY["ğŸš€ COOLIFY<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>2GB | Port 8000<br/><br/>Manages:<br/>â€¢ VPS2 services<br/>â€¢ VPS3 services<br/>â€¢ Docker compose<br/>â€¢ Health checks<br/>â€¢ Rollbacks<br/><br/>Features:<br/>â€¢ Zero-downtime<br/>â€¢ Auto-rollback<br/>â€¢ Health monitoring"]
    end
    
    subgraph MONITORING_CICD["ğŸ“Š MONITORING"]
        direction LR
        
        PROMETHEUS_CICD["ğŸ“ˆ PROMETHEUS<br/>CI/CD Metrics<br/>â€¢ Build duration<br/>â€¢ Success rate<br/>â€¢ Deploy frequency<br/>â€¢ Rollback rate"]
        
        GRAFANA_CICD["ğŸ“Š GRAFANA<br/>CI/CD Dashboard<br/>â€¢ Pipeline status<br/>â€¢ Build trends<br/>â€¢ Security issues<br/>â€¢ Deploy history"]
        
        ALERTA_CICD["ğŸš¨ ALERTA<br/>CI/CD Alerts<br/>â€¢ Build failed<br/>â€¢ Security vuln<br/>â€¢ Deploy failed<br/>â€¢ Rollback triggered"]
    end
    
    subgraph AGENTS_CICD["ğŸ¤– AI AGENTS"]
        direction LR
        
        DEVOPS_AGENT["ğŸ”§ DEVOPS AGENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Monitors:<br/>â€¢ Pipeline status<br/>â€¢ Build failures<br/>â€¢ Deploy issues<br/><br/>Actions:<br/>â€¢ Auto-retry builds<br/>â€¢ Rollback on error<br/>â€¢ Notify team<br/>â€¢ Create incident"]
        
        TEST_AGENT["ğŸ§ª TEST AGENT<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Runs:<br/>â€¢ E2E tests<br/>â€¢ API tests<br/>â€¢ Load tests<br/><br/>Reports:<br/>â€¢ Test results<br/>â€¢ Coverage<br/>â€¢ Performance"]
    end
    
    %% Connections - Developer to Gitea
    DEV --> GITEA
    
    %% Connections - Gitea internal
    GITEA --> GITEA_DB
    GITEA --> RUNNER
    
    %% Connections - Pipeline flow
    GITEA --> TRIGGER
    TRIGGER --> SECURITY
    SECURITY --> BUILD
    BUILD --> PUSH
    PUSH --> DEPLOY
    DEPLOY --> VERIFY
    VERIFY --> NOTIFY
    
    %% Connections - Security
    SECURITY --> TRIVY
    TRIVY --> TRIVYIGNORE
    
    %% Connections - Registry
    PUSH --> ZOT
    DEPLOY --> ZOT
    
    %% Connections - Deployment
    DEPLOY --> COOLIFY
    
    %% Connections - Monitoring
    RUNNER --> PROMETHEUS_CICD
    COOLIFY --> PROMETHEUS_CICD
    PROMETHEUS_CICD --> GRAFANA_CICD
    PROMETHEUS_CICD --> ALERTA_CICD
    
    %% Connections - Agents
    ALERTA_CICD --> DEVOPS_AGENT
    DEVOPS_AGENT --> COOLIFY
    RUNNER --> TEST_AGENT
    
    %% Connections - Notifications
    NOTIFY --> DEV
    NOTIFY --> DEVOPS_AGENT
    
    %% Rollback flow
    VERIFY -.->|Failed| COOLIFY
    COOLIFY -.->|Rollback| VERIFY
    
    %% Styling
    classDef developerStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    classDef giteaStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px
    classDef pipelineStyle fill:#E1F5FE,stroke:#0277BD,stroke-width:2px
    classDef securityStyle fill:#FFEBEE,stroke:#C62828,stroke-width:2px
    classDef registryStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    classDef deployStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef monitoringStyle fill:#FFF9C4,stroke:#F9A825,stroke-width:2px
    classDef agentStyle fill:#FFCCBC,stroke:#E64A19,stroke-width:2px
    
    class DEV developerStyle
    class GITEA,GITEA_DB,RUNNER giteaStyle
    class TRIGGER,BUILD,PUSH,DEPLOY,VERIFY,NOTIFY pipelineStyle
    class SECURITY,TRIVY,TRIVYIGNORE securityStyle
    class ZOT registryStyle
    class COOLIFY deployStyle
    class PROMETHEUS_CICD,GRAFANA_CICD,ALERTA_CICD monitoringStyle
    class DEVOPS_AGENT,TEST_AGENT agentStyle
